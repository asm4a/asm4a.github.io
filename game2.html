<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>لعبة الخداع الجماعية</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 20px auto;
    max-width: 600px;
    background: #f0f4f8;
    color: #333;
    direction: rtl;
  }
  h1 {
    text-align: center;
    color: #004aad;
    margin-bottom: 30px;
  }
  h2, h3 {
    margin-top: 25px;
    color: #004aad;
  }
  button {
    margin: 10px 0;
    padding: 12px;
    font-size: 17px;
    width: 100%;
    border: none;
    border-radius: 6px;
    background-color: #007bff;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:disabled {
    background-color: #7aaefc;
    cursor: not-allowed;
  }
  button:hover:not(:disabled) {
    background-color: #0056b3;
  }
  input {
    padding: 12px;
    width: 100%;
    font-size: 17px;
    border: 1.5px solid #ccc;
    border-radius: 6px;
    box-sizing: border-box;
    margin-bottom: 10px;
  }
  ul {
    list-style: none;
    padding-right: 0;
  }
  ul li {
    background: white;
    padding: 10px 15px;
    margin-bottom: 6px;
    border-radius: 6px;
    box-shadow: 0 1px 4px rgb(0 0 0 / 0.1);
  }
  #answersContainer button {
    background-color: #28a745;
    margin-bottom: 8px;
  }
  #answersContainer button:hover:not(:disabled) {
    background-color: #19692c;
  }
  #answersContainer button:disabled {
    background-color: #a0d7a6;
    cursor: not-allowed;
  }
  .error {
    color: #d93025;
    margin-top: -8px;
    margin-bottom: 10px;
    font-weight: bold;
  }
  #roundResults ul {
    padding-right: 20px;
  }
  #leaderboard ol {
    padding-right: 20px;
  }
</style>
</head>
<body>

<h1>لعبة الخداع الجماعية</h1>

<div id="setup">
  <h2>أضف أسماء اللاعبين</h2>
  <input id="playerNameInput" placeholder="أدخل اسم اللاعب" />
  <button id="addPlayerBtn">إضافة لاعب</button>
  <ul id="playerList"></ul>
  <button id="startGameBtn" disabled>ابدأ اللعبة</button>
</div>

<div id="game" class="hidden">

  <h2 id="questionText"></h2>

  <div id="answerPhase">
    <h3>اللاعب <span id="currentPlayerName"></span>، اكتب جوابك المزيف:</h3>
    <input id="fakeAnswerInput" placeholder="اكتب جوابك المزيف هنا" />
    <p class="error" id="answerError"></p>
    <button id="submitFakeAnswerBtn">أرسل الجواب</button>
  </div>

  <div id="votingPhase" class="hidden">
    <h3>الخيارات كلها:</h3>
    <div id="answersContainer"></div>
    <h3>اللاعب <span id="votingPlayerName"></span>، اختر الجواب الصحيح:</h3>
    <p class="error" id="voteError"></p>
  </div>

  <div id="resultsPhase" class="hidden">
    <h3>نتائج الجولة:</h3>
    <div id="roundResults"></div>
    <h3>الترتيب العام:</h3>
    <div id="leaderboard"></div>
    <button id="nextRoundBtn">جولة جديدة</button>
  </div>

</div>

<script>
(() => {
  const questions = [
    { id: 1, text: "ما هي عاصمة فرنسا؟", correct: "باريس" },
    { id: 2, text: "ما العنصر الذي رمزه الكيميائي 'O'؟", correct: "الأكسجين" },
    { id: 3, text: "من رسم لوحة الموناليزا؟", correct: "ليوناردو دافنشي" },
    { id: 4, text: "ما أكبر كوكب في المجموعة الشمسية؟", correct: "المشتري" },
  ];

  let players = [];
  let currentQuestion = null;
  let fakeAnswers = [];
  let allAnswers = [];
  let currentFakeAnswerPlayer = 0;
  let currentVotingPlayer = 0;
  let votes = [];
  let points = [];

  const setupDiv = document.getElementById('setup');
  const playerNameInput = document.getElementById('playerNameInput');
  const addPlayerBtn = document.getElementById('addPlayerBtn');
  const playerList = document.getElementById('playerList');
  const startGameBtn = document.getElementById('startGameBtn');

  const gameDiv = document.getElementById('game');
  const questionText = document.getElementById('questionText');
  const answerPhase = document.getElementById('answerPhase');
  const currentPlayerNameSpan = document.getElementById('currentPlayerName');
  const fakeAnswerInput = document.getElementById('fakeAnswerInput');
  const answerError = document.getElementById('answerError');
  const submitFakeAnswerBtn = document.getElementById('submitFakeAnswerBtn');

  const votingPhase = document.getElementById('votingPhase');
  const answersContainer = document.getElementById('answersContainer');
  const votingPlayerNameSpan = document.getElementById('votingPlayerName');
  const voteError = document.getElementById('voteError');

  const resultsPhase = document.getElementById('resultsPhase');
  const roundResults = document.getElementById('roundResults');
  const leaderboardDiv = document.getElementById('leaderboard');
  const nextRoundBtn = document.getElementById('nextRoundBtn');

  function refreshPlayerList() {
    playerList.innerHTML = '';
    players.forEach(p => {
      const li = document.createElement('li');
      li.textContent = p;
      playerList.appendChild(li);
    });
    startGameBtn.disabled = players.length < 2;
  }

  addPlayerBtn.onclick = () => {
    const name = playerNameInput.value.trim();
    if (!name) return alert('يرجى إدخال اسم اللاعب');
    if (players.includes(name)) return alert('هذا الاسم موجود مسبقاً');
    players.push(name);
    playerNameInput.value = '';
    refreshPlayerList();
  };

  startGameBtn.onclick = () => {
    setupDiv.classList.add('hidden');
    gameDiv.classList.remove('hidden');
    startNewRound();
  };

  function startNewRound() {
    currentQuestion = questions[Math.floor(Math.random() * questions.length)];
    fakeAnswers = [];
    allAnswers = [];
    votes = new Array(players.length).fill(null);
    currentFakeAnswerPlayer = 0;
    currentVotingPlayer = 0;
    answerError.textContent = '';
    voteError.textContent = '';

    questionText.textContent = currentQuestion.text;

    answerPhase.classList.remove('hidden');
    votingPhase.classList.add('hidden');
    resultsPhase.classList.add('hidden');

    currentPlayerNameSpan.textContent = players[currentFakeAnswerPlayer];
    fakeAnswerInput.value = '';
    fakeAnswerInput.disabled = false;
    submitFakeAnswerBtn.disabled = false;
    fakeAnswerInput.focus();
  }

  submitFakeAnswerBtn.onclick = () => {
    const answer = fakeAnswerInput.value.trim();
    if (!answer) {
      answerError.textContent = 'الجواب لا يمكن أن يكون فارغاً!';
      return;
    }
    if (answer.toLowerCase() === currentQuestion.correct.toLowerCase()) {
      answerError.textContent = 'لا يمكنك إدخال الجواب الصحيح!';
      return;
    }

    fakeAnswers.push({ playerIndex: currentFakeAnswerPlayer, text: answer });
    answerError.textContent = '';

    currentFakeAnswerPlayer++;
    if (currentFakeAnswerPlayer < players.length) {
      currentPlayerNameSpan.textContent = players[currentFakeAnswerPlayer];
      fakeAnswerInput.value = '';
      fakeAnswerInput.focus();
    } else {
      allAnswers = fakeAnswers.slice();
      allAnswers.push({ playerIndex: null, text: currentQuestion.correct, isCorrect: true });

      allAnswers = allAnswers
        .map(a => ({ ...a, sortKey: Math.random() }))
        .sort((a,b) => a.sortKey - b.sortKey)
        .map(({ sortKey, ...rest }) => rest);

      answerPhase.classList.add('hidden');
      votingPhase.classList.remove('hidden');
      currentVotingPlayer = 0;
      voteError.textContent = '';
      renderVoting();
    }
  };

  function renderVoting() {
    votingPlayerNameSpan.textContent = players[currentVotingPlayer];
    answersContainer.innerHTML = '';

    allAnswers.forEach((answer, index) => {
      const btn = document.createElement('button');
      btn.textContent = answer.text;
      btn.onclick = () => {
        if (answer.playerIndex === currentVotingPlayer) {
          voteError.textContent = 'لا يمكنك اختيار جوابك الخاص!';
          return;
        }
        voteError.textContent = '';
        votes[currentVotingPlayer] = index;
        currentVotingPlayer++;
        if (currentVotingPlayer < players.length) {
          renderVoting();
        } else {
          showResults();
        }
      };
      answersContainer.appendChild(btn);
    });
  }

  function showResults() {
    votingPhase.classList.add('hidden');
    resultsPhase.classList.remove('hidden');

    if (points.length === 0) points = new Array(players.length).fill(0);

    const correctIndex = allAnswers.findIndex(a => a.isCorrect);

    votes.forEach((chosenIndex, voterIndex) => {
      if (chosenIndex === correctIndex) {
        points[voterIndex]++;
      } else {
        const owner = allAnswers[chosenIndex].playerIndex;
        if (owner !== null && owner !== undefined) {
          points[owner]++;
        }
      }
    });

    let resultsHTML = '<ul>';
    votes.forEach((voteIndex, voterIndex) => {
      const voterName = players[voterIndex];
      const votedAnswer = allAnswers[voteIndex].text;
      resultsHTML += `<li><b>${voterName}</b> اختار: "${votedAnswer}"</li>`;
    });
    resultsHTML += '</ul>';
    roundResults.innerHTML = resultsHTML;

    let leaderboardHTML = '<ol>';
    const leaderboard = players.map((name, idx) => ({ name, points: points[idx] }));
    leaderboard.sort((a,b) => b.points - a.points);
    leaderboard.forEach(p => {
      leaderboardHTML += `<li>${p.name}: ${p.points} نقطة</li>`;
    });
    leaderboardHTML += '</ol>';
    leaderboardDiv.innerHTML = leaderboardHTML;
  }

  nextRoundBtn.onclick = () => {
    startNewRound();
  };

  refreshPlayerList();
})();
</script>

</body>
</html>
